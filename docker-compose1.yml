version: '3'
services:
  spark-master:
    build: ./spark
    image: spark-image
    networks:
      iceberg_net:
    ports:
      - "8080:8080"
      - "7077:7077"
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
    hostname: spark-master
    entrypoint: ["./start-master.sh"]  # Specify entry point for master

  spark-worker:
    build: ./spark
    image: spark-image
    networks:
      iceberg_net:
    ports:
      - "8081:8081"
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
    entrypoint: ["./start-worker.sh"]  # Specify entry point for worker
    depends_on:
      - spark-master

  spark-worker2:
    build: ./spark
    image: spark-image
    networks:
      iceberg_net:
    ports:
      - "8082:8081"
    environment:
      - SPARK_MODE=worker
      - SPARK_MASTER_URL=spark://spark-master:7077
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
    entrypoint: ["./start-worker.sh"]
    depends_on:
      - spark-master

  prometheus:
    image: prom/prometheus
    networks:
      iceberg_net:
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus:/prometheus
    command:
      - '--config.file=/prometheus/prometheus.yml'
    restart: always

  pushgateway:
    image: prom/pushgateway
    networks:
      iceberg_net:
    ports:
      - "9091:9091"
    restart: always

  grafana:
    image: grafana/grafana-enterprise
    container_name: grafana
    networks:
      iceberg_net:
    ports:
      - "3001:3000"
    restart: always
    environment:
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - GF_AUTH_ANONYMOUS_ORG_NAME=teamCaspian
      - GF_AUTH_PROXY_ENABLED=true
      - GF_AUTH_PROXY_HEADER_NAME="Authorization"
      - GF_AUTH_PROXY_HEADER_PROPERTY="Bearer glsa_9ctpxoguuudd2CKn3EfrUwJXgQdQAL86_3724fa0b"
      - GF_AUTH_PROXY_AUTO_SIGN_UP=true
      - GF_SERVER_ROOT_URL=http://localhost:3001
      - GF_REDIRECT_URL=http://localhost:3001/d/adju7v39wqo00a/test-dashboard?orgId=1&from=1714061239559&to=1714082839559
      - GF_SECURITY_ALLOW_EMBEDDING=true
    volumes:
      - grafana:/var/lib/grafana

  rest:
    image: tabulario/iceberg-rest
    container_name: iceberg-rest
    networks:
      iceberg_net:
    ports:
      - "8181:8181"
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
      - CATALOG_WAREHOUSE=s3a://warehouse/
      - CATALOG_IO__IMPL=org.apache.iceberg.aws.s3.S3FileIO
      - CATALOG_S3_ENDPOINT=http://minio:9000
  minio:
    image: minio/minio
    container_name: minio
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      - MINIO_DOMAIN=minio
    networks:
      iceberg_net:
        aliases:
          - warehouse.minio
    ports:
      - "9001:9001"
      - "9000:9000"
    command: ["server", "/data", "--console-address", ":9001"]
    volumes:
       - minio_data:/data
  mc:
    depends_on:
      - minio
    image: minio/mc
    container_name: mc
    networks:
      iceberg_net:
    environment:
      - AWS_ACCESS_KEY_ID=admin
      - AWS_SECRET_ACCESS_KEY=password
      - AWS_REGION=us-east-1
    volumes:
      - ./init-minio.sh:/init-minio.sh
    entrypoint: [ "/bin/sh", "-c", "/init-minio.sh" ]
    
volumes:
  minio_data:
  grafana:
  prometheus:

networks:
  iceberg_net:
    driver: bridge